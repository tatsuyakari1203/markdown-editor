Chắc chắn rồi\! Việc tích hợp OpenAPI (Swagger) vào backend Fastify của bạn là một ý tưởng tuyệt vời để tự động hóa việc tạo và hiển thị tài liệu API. Dựa trên cấu trúc dự án của bạn, đây là các bước chi tiết để triển khai:

### Triển khai OpenAPI (Swagger) cho Backend Fastify

Bạn sẽ sử dụng hai thư viện chính: `@fastify/swagger` để tạo ra định dạng OpenAPI và `@fastify/swagger-ui` để hiển thị giao diện Swagger UI đẹp mắt.

-----

#### **Bước 1: Cài đặt các thư viện cần thiết**

Mở terminal và chạy lệnh sau để cài đặt các dependencies:

```bash
npm install @fastify/swagger @fastify/swagger-ui
# hoặc
yarn add @fastify/swagger @fastify/swagger-ui
```

-----

#### **Bước 2: Cập nhật file `src/backend/server.ts`**

Bạn cần đăng ký (register) hai plugin vừa cài đặt vào trong file server chính. Đây là nơi bạn sẽ cấu hình Swagger.

Mở file `src/backend/server.ts` và thêm vào phần `registerPlugins`:

```typescript
// Trong file: src/backend/server.ts
import Fastify from 'fastify';
import cors from '@fastify/cors';
import staticFiles from '@fastify/static';
import cookie from '@fastify/cookie';
import { join } from 'path';
import { authMiddleware, optionalAuthMiddleware } from './middleware/auth.js';
import { authRoutes } from './routes/auth.js';
import { documentRoutes } from './routes/documents.js';
import { filesRoutes } from './routes/files.js';
import { UserService } from './services/userService.js';
import { DatabaseConnection } from './database/connection.js';

// Thêm 2 import này
import fastifySwagger from '@fastify/swagger';
import fastifySwaggerUi from '@fastify/swagger-ui';

// ... (phần còn lại của file)

// Register plugins
async function registerPlugins() {
  // ... (các plugin hiện có như cors, cookie)

  // Đăng ký Swagger
  await fastify.register(fastifySwagger, {
    swagger: {
      info: {
        title: 'KMDE API Documentation',
        description: 'API for the KariS Markdown Editor (KMDE), managing authentication, documents, and file structures. Generated by Swagger.',
        version: '0.1.0' // Bạn có thể lấy version từ package.json
      },
      externalDocs: {
        url: 'https://github.com/tatsuyakari1203/markdown-editor',
        description: 'Find more info here'
      },
      host: 'localhost:3001', // Thay đổi nếu cần
      schemes: ['http'],
      consumes: ['application/json'],
      produces: ['application/json'],
      tags: [ // Phân loại các API
        { name: 'auth', description: 'Authentication related end-points' },
        { name: 'documents', description: 'Document management end-points' },
        { name: 'files', description: 'File and folder tree operations' },
        { name: 'settings', description: 'User settings end-points'},
        { name: 'media', description: 'Media file management'}
      ],
      securityDefinitions: { // Định nghĩa cách xác thực
        bearerAuth: {
          type: 'apiKey',
          name: 'Authorization',
          in: 'header',
          description: "Enter your bearer token in the format: Bearer <token>"
        }
      }
    }
  });

  // Đăng ký Swagger UI để hiển thị
  await fastify.register(fastifySwaggerUi, {
    routePrefix: '/api/docs', // Đường dẫn để xem API docs, ví dụ: http://localhost:3001/api/docs
    uiConfig: {
      docExpansion: 'list', // 'list' (mở các tag), 'full' (mở hết), 'none'
      deepLinking: true
    },
    staticCSP: true,
    transformStaticCSP: (header) => header,
  });

  // ... (các plugin còn lại)
}

// ... (phần còn lại của file)
```

-----

#### **Bước 3: Tận dụng Route Schema có sẵn**

Một điểm rất mạnh trong code của bạn là bạn đã định nghĩa `schema` cho từng route. `@fastify/swagger` sẽ **tự động** đọc các schema này để tạo ra tài liệu API chi tiết.

Để tài liệu API đẹp và đầy đủ hơn, bạn có thể bổ sung thêm các trường như `summary`, `description`, và `tags` vào schema của mỗi route.

**Ví dụ cải thiện route login trong `src/backend/routes/auth.ts`:**

```typescript
// Trong file: src/backend/routes/auth.ts
fastify.post<{ Body: LoginRequest; }>('/login', {
    schema: {
      // Bổ sung các thông tin này
      summary: 'User Login',
      description: 'Logs in a user and returns a session token.',
      tags: ['auth'], // Phân loại vào nhóm 'auth'
      body: {
        type: 'object',
        required: ['username', 'password'],
        properties: {
          username: { type: 'string', description: 'The username to log in with.' },
          password: { type: 'string', format: 'password', description: 'The user\'s password.' }
        }
      },
      response: { // Định nghĩa các response có thể có
        200: {
            description: 'Successful login response',
            type: 'object',
            properties: {
                success: { type: 'boolean' },
                data: {
                    type: 'object',
                    properties: {
                        user: { /* ...định nghĩa user object... */ },
                        session: { /* ...định nghĩa session object... */ }
                    }
                }
            }
        },
        401: {
            description: 'Invalid credentials',
            type: 'object',
            properties: {
                 success: { type: 'boolean', default: false },
                 error: {
                     type: 'object',
                     properties: {
                         code: { type: 'string' },
                         message: { type: 'string' }
                     }
                 }
            }
        }
      }
    }
  }, async (request, reply) => {
    // ... (logic của bạn)
});
```

Bạn có thể áp dụng tương tự cho các route khác để tài liệu trở nên cực kỳ chi tiết.

-----

#### **Bước 4: Chạy Backend và xem kết quả**

Sau khi hoàn tất các thay đổi, hãy khởi động lại server backend của bạn:

```bash
yarn dev:server
```

Bây giờ, hãy mở trình duyệt và truy cập vào đường dẫn bạn đã cấu hình trong `routePrefix`:

**[http://localhost:3001/api/docs](https://www.google.com/search?q=http://localhost:3001/api/docs)**

Bạn sẽ thấy một giao diện Swagger UI chuyên nghiệp, liệt kê tất cả các API endpoint của bạn, cho phép bạn xem chi tiết và thậm chí là **thử nghiệm API trực tiếp** trên giao diện này.

Vậy là xong\! Bạn đã tích hợp thành công OpenAPI/Swagger vào backend của mình, giúp việc quản lý và chia sẻ tài liệu API trở nên tự động và hiệu quả hơn rất nhiều.